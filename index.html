<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cashback Tracker</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #ffecd2, #fcb69f);
      display: flex;
      justify-content: center;
      padding: 30px;
      transition: background 0.3s ease;
    }
    .dark-mode {
      background: linear-gradient(135deg, #1e1e1e, #2c2c2c);
      color: #fff;
    }

    .container {
      background: #fff;
      width: 100%;
      max-width: 600px;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      transition: background 0.3s ease, color 0.3s ease;
    }

    .dark-mode .container {
      background: #333;
      color: #fff;
    }

    h1, h3 {
      margin: 0;
      color: #333;
    }

    .dark-mode h1, .dark-mode h3 {
      color: #fff;
    }

    .top-bar h3 {
      margin-left: 15px; /* Added spacing from menu button */
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    input, select {
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 10px;
      outline: none;
      transition: 0.2s ease;
    }

    input:focus, select:focus {
      border-color: #ff7e5f;
      box-shadow: 0 0 5px rgba(255, 126, 95, 0.5);
    }

    button {
      background: linear-gradient(to right, #ff416c, #ff4b2b);
      color: white;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.3s ease;
    }

    button:hover {
      opacity: 0.95;
    }

    .btn-secondary {
      background: #888;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 10px;
      text-align: center;
    }

    th {
      background: #ff7e5f;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .dark-mode tr:nth-child(even) {
      background-color: #444;
    }

    .selected {
      background-color: #ffecd2 !important;
      transition: background-color 0.2s ease;
    }

    .dark-mode .selected {
      background-color: #555 !important;
    }

    #total {
      margin-top: 20px;
      text-align: center;
      font-size: 18px;
      background: #ffe0e0;
      padding: 10px;
      border-radius: 10px;
      font-weight: bold;
    }

    .dark-mode #total {
      background: #555;
      color: #fff;
    }

    .top-bar {
      display: flex;
      justify-content: flex-start; /* Adjusted to align menu button and text */
      align-items: center;
      margin-bottom: 20px;
    }

    .multi-btns {
      display: none;
      justify-content: space-between;
      margin-top: 10px;
      gap: 10px;
    }

    /* Menu Styles */
    #menuButton {
      font-size: 24px;
      background: none;
      border: none;
      cursor: pointer;
      color: inherit;
    }

    .menu {
      display: none;
      position: absolute;
      top: 70px;
      left: 30px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      padding: 10px;
      z-index: 100;
      width: 200px;
    }

    .dark-mode .menu {
      background: #333;
      color: #fff;
    }

    .menu-item {
      padding: 10px;
      cursor: pointer;
      border-radius: 5px;
      transition: background 0.2s ease;
    }

    .menu-item:hover {
      background: #ffecd2;
    }

    .dark-mode .menu-item:hover {
      background: #555;
    }

    .menu-form {
      display: none;
      flex-direction: column;
      gap: 10px;
      padding: 10px;
    }

    .menu-form input {
      width: 100%;
    }

    .menu.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <button id="menuButton">☰</button>
      <h3>Airtel Axis Cashback Tracker</h3>
      <!-- Removed darkModeToggle button -->
    </div>
    <div class="menu" id="menu">
      <div class="menu-item" onclick="toggleDarkMode()">Dark Mode</div>
      <div class="menu-item" onclick="clearLocalData()">Clear Local Data</div>
      <div class="menu-item" onclick="showBillingCycleForm()">Change Billing Cycle Period</div>
      <div class="menu-form" id="billingCycleForm">
        <input type="number" id="billingCycleStartDay" min="1" max="28" placeholder="Enter start day (1-28)" />
        <button onclick="saveBillingCycle()">Save</button>
      </div>
    </div>
    <div class="input-group">
      <input type="date" id="txnDate" />
      <select id="category">
        <option value="">Select Category</option>
        <option value="airtel">Airtel Bill/Recharge</option>
        <option value="utility">Utility via Airtel Thanks / Other Operators Recharge</option>
        <option value="partner">Swiggy/Zomato/BigBasket</option>
        <option value="others">Other</option>
        <option value="excluded">Excluded Spend</option>
      </select>
      <input type="number" id="amount" placeholder="Enter amount" />
      <button id="submitBtn" onclick="addTransaction()">Add Transaction</button>
      <div class="multi-btns" id="editDeleteBtns">
        <button onclick="confirmEdit()">Update</button>
        <button onclick="confirmDelete()">Delete</button>
      </div>
      <button class="btn-secondary" onclick="exportToCSV()">Export CSV</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Category</th>
          <th>Spend (₹)</th>
          <th>%</th>
          <th>Cashback (₹)</th>
        </tr>
      </thead>
      <tbody id="transactions"></tbody>
    </table>

    <div id="total">Total Cashback Earned: ₹0</div>
  </div>

  <script>
    const cashbackRates = {
      airtel: 25,
      utility: 10,
      partner: 10,
      others: 1,
      excluded: 0
    };

    const cashbackCaps = {
      airtel: 250,
      utility: 250,
      partner: 500
    };

    let monthlyTracker = {};
    let totalCashback = 0;
    let transactions = [];
    let selectedIndex = -1;
    let billingCycleStartDay = parseInt(localStorage.getItem('billingCycleStartDay')) || 13;

    // Save transactions and monthlyTracker to localStorage
    function saveTransactions() {
      localStorage.setItem('transactions', JSON.stringify(transactions));
      localStorage.setItem('monthlyTracker', JSON.stringify(monthlyTracker));
    }

    // Load transactions and monthlyTracker from localStorage
    function loadTransactions() {
      const savedTransactions = localStorage.getItem('transactions');
      const savedTracker = localStorage.getItem('monthlyTracker');
      if (savedTransactions) {
        transactions = JSON.parse(savedTransactions);
      }
      if (savedTracker) {
        monthlyTracker = JSON.parse(savedTracker);
      }
    }

    function getBillingKey(dateStr) {
      const date = new Date(dateStr);
      const day = date.getDate();
      let month = date.getMonth();
      let year = date.getFullYear();

      if (day < billingCycleStartDay) {
        month = month === 0 ? 11 : month - 1;
        if (month === 11) year -= 1;
      }
      return `${year}-${String(month + 1).padStart(2, '0')}`;
    }

    function getBillingCycleDates(dateStr) {
      const date = new Date(dateStr);
      const day = date.getDate();
      let month = date.getMonth();
      let year = date.getFullYear();

      if (day < billingCycleStartDay) {
        month = month === 0 ? 11 : month - 1;
        if (month === 11) year -= 1;
      }

      const startMonth = month + 1;
      const startDate = `${billingCycleStartDay}/${String(startMonth).padStart(2, '0')}/${year}`;
      const endMonth = (month + 1) % 12 + 1;
      const endYear = month + 1 >= 12 ? year + 1 : year;
      const endDay = billingCycleStartDay - 1 || 28; // Last day of cycle
      const endDate = `${endDay}/${String(endMonth).padStart(2, '0')}/${endYear}`;

      return { startDate, endDate };
    }

    function isOlderBillingCycle(txnDateStr) {
      const today = new Date();
      const currentBillingKey = getBillingKey(today.toISOString().split('T')[0]);
      const txnBillingKey = getBillingKey(txnDateStr);
      return txnBillingKey < currentBillingKey;
    }

    function getToday() {
      const d = new Date();
      return d.toISOString().split('T')[0];
    }

    function resetForm() {
      document.getElementById('txnDate').value = getToday();
      document.getElementById('category').value = '';
      document.getElementById('amount').value = '';
      selectedIndex = -1;
      document.getElementById('editDeleteBtns').style.display = 'none';
      updateTable();
    }

    function calculateCashback(date, category, amount) {
      const rate = cashbackRates[category];
      let rawCashback = (amount * rate) / 100;
      let finalCashback = rawCashback;
      const key = getBillingKey(date);

      if (!monthlyTracker[key]) {
        monthlyTracker[key] = { airtel: 0, utility: 0, partner: 0 };
      }

      if (['airtel', 'utility', 'partner'].includes(category)) {
        const current = monthlyTracker[key][category];
        const cap = cashbackCaps[category];

        if (current >= cap) {
          alert(`Max cashback limit of ₹${cap} reached for "${category}" this billing cycle.`);
          finalCashback = 0;
        } else if (current + rawCashback > cap) {
          finalCashback = cap - current;
          alert(`Only ₹${finalCashback.toFixed(2)} cashback added (limit reached).`);
        }

        monthlyTracker[key][category] += finalCashback;
      }

      return finalCashback;
    }

    function updateTable() {
      const tbody = document.getElementById('transactions');
      tbody.innerHTML = '';
      totalCashback = 0;

      transactions.forEach((txn, index) => {
        const row = document.createElement('tr');
        if (index === selectedIndex) {
          row.classList.add('selected');
        }
        row.innerHTML = `
          <td>${txn.date}</td>
          <td>${txn.category}</td>
          <td>₹${txn.amount.toFixed(2)}</td>
          <td>${txn.rate}%</td>
          <td>₹${txn.cashback.toFixed(2)}</td>
        `;
        row.style.cursor = 'pointer';
        row.addEventListener('click', () => selectTransaction(index));
        tbody.appendChild(row);
        totalCashback += txn.cashback;
      });

      document.getElementById('total').innerText = `Total Cashback Earned: ₹${totalCashback.toFixed(2)}`;
    }

    function addTransaction() {
      const date = document.getElementById('txnDate').value;
      const category = document.getElementById('category').value;
      const amount = parseFloat(document.getElementById('amount').value);

      if (!date || !category || isNaN(amount) || amount <= 0) {
        alert("Please enter valid date, category, and amount.");
        return;
      }

      if (isOlderBillingCycle(date)) {
        const { startDate, endDate } = getBillingCycleDates(date);
        alert(`Cannot add transaction. Date belongs to an older billing cycle (${startDate} to ${endDate}).`);
        return;
      }

      const rate = cashbackRates[category];
      const cashback = calculateCashback(date, category, amount);

      const txnData = {
        date,
        category,
        amount,
        rate,
        cashback
      };

      transactions.push(txnData);
      saveTransactions();
      updateTable();
      resetForm();
    }

    function selectTransaction(index) {
      selectedIndex = index;
      const txn = transactions[index];
      document.getElementById('txnDate').value = txn.date;
      document.getElementById('category').value = txn.category;
      document.getElementById('amount').value = txn.amount;
      document.getElementById('editDeleteBtns').style.display = 'flex';
      updateTable();
    }

    function confirmEdit() {
      if (selectedIndex >= 0) {
        const date = document.getElementById('txnDate').value;
        const category = document.getElementById('category').value;
        const amount = parseFloat(document.getElementById('amount').value);

        if (!date || !category || isNaN(amount) || amount <= 0) {
          alert("Please enter valid date, category, and amount.");
          return;
        }

        if (isOlderBillingCycle(date)) {
          const { startDate, endDate } = getBillingCycleDates(date);
          alert(`Cannot update transaction. New date belongs to an older billing cycle (${startDate} to ${endDate}).`);
          return;
        }

        // Remove old cashback from monthlyTracker
        const oldTxn = transactions[selectedIndex];
        const oldKey = getBillingKey(oldTxn.date);
        if (['airtel', 'utility', 'partner'].includes(oldTxn.category)) {
          monthlyTracker[oldKey][oldTxn.category] -= oldTxn.cashback;
          if (monthlyTracker[oldKey][oldTxn.category] <= 0) {
            delete monthlyTracker[oldKey][oldTxn.category];
          }
          if (Object.keys(monthlyTracker[oldKey]).length === 0) {
            delete monthlyTracker[oldKey];
          }
        }

        const rate = cashbackRates[category];
        const cashback = calculateCashback(date, category, amount);

        transactions[selectedIndex] = { date, category, amount, rate, cashback };
        saveTransactions();
        updateTable();
        resetForm();
      }
    }

    function confirmDelete() {
      if (selectedIndex >= 0 && confirm("Are you sure you want to delete this transaction?")) {
        // Remove cashback from monthlyTracker
        const oldTxn = transactions[selectedIndex];
        const oldKey = getBillingKey(oldTxn.date);
        if (['airtel', 'utility', 'partner'].includes(oldTxn.category)) {
          monthlyTracker[oldKey][oldTxn.category] -= oldTxn.cashback;
          if (monthlyTracker[oldKey][oldTxn.category] <= 0) {
            delete monthlyTracker[oldKey][oldTxn.category];
          }
          if (Object.keys(monthlyTracker[oldKey]).length === 0) {
            delete monthlyTracker[oldKey];
          }
        }

        transactions.splice(selectedIndex, 1);
        saveTransactions();
        updateTable();
        resetForm();
      }
    }

    function exportToCSV() {
      if (transactions.length === 0) {
        alert("No transactions to export.");
        return;
      }

      const headers = ["Date", "Category", "Amount", "Rate", "Cashback"];
      const rows = transactions.map(txn => [
        `"${txn.date}"`,
        `"${txn.category}"`,
        txn.amount.toFixed(2),
        txn.rate,
        txn.cashback.toFixed(2)
      ]);

      const csvContent = [headers, ...rows].map(e => e.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "cashback_transactions.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Menu Functions
    function toggleMenu() {
      const menu = document.getElementById('menu');
      menu.classList.toggle('active');
      document.getElementById('billingCycleForm').style.display = 'none';
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      toggleMenu(); // Close menu after toggling dark mode
    }

    function clearLocalData() {
      if (confirm("Are you sure you want to clear all transactions and data?")) {
        transactions = [];
        monthlyTracker = {};
        localStorage.removeItem('transactions');
        localStorage.removeItem('monthlyTracker');
        saveTransactions();
        updateTable();
        resetForm();
        toggleMenu();
      }
    }

    function showBillingCycleForm() {
      const form = document.getElementById('billingCycleForm');
      form.style.display = form.style.display === 'flex' ? 'none' : 'flex';
      document.getElementById('billingCycleStartDay').value = billingCycleStartDay;
    }

    function saveBillingCycle() {
      const newStartDay = parseInt(document.getElementById('billingCycleStartDay').value);
      if (isNaN(newStartDay) || newStartDay < 1 || newStartDay > 28) {
        alert("Please enter a valid day (1-28).");
        return;
      }
      billingCycleStartDay = newStartDay;
      localStorage.setItem('billingCycleStartDay', billingCycleStartDay);
      // Recalculate billing keys and cashback
      monthlyTracker = {};
      transactions.forEach(txn => {
        if (['airtel', 'utility', 'partner'].includes(txn.category)) {
          const key = getBillingKey(txn.date);
          if (!monthlyTracker[key]) {
            monthlyTracker[key] = { airtel: 0, utility: 0, partner: 0 };
          }
          monthlyTracker[key][txn.category] += txn.cashback;
        }
      });
      saveTransactions();
      updateTable();
      toggleMenu();
    }

    // Event Listeners
    document.getElementById('menuButton').addEventListener('click', toggleMenu);

    window.onload = () => {
      loadTransactions();
      document.getElementById('txnDate').value = getToday();
      updateTable();
    };
  </script>
</body>
</html>
